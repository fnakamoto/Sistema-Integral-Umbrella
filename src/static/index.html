<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umbrella Leads Manager - Pipeline</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 30px;
        }
        #pipeline-container {
            display: flex;
            overflow-x: auto; /* Permite rolagem horizontal se houver muitas colunas */
            gap: 20px;
            padding-bottom: 20px;
        }
        .pipeline-column {
            flex-shrink: 0; /* Impede que as colunas encolham */
            width: 300px; /* Largura fixa para cada coluna */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            min-height: 400px; /* Altura mínima para as colunas */
            transition: background-color 0.2s ease-in-out; /* Transição para feedback visual */
        }
        .pipeline-column.drag-over {
            background-color: #e0f7fa; /* Cor de fundo quando um card está sobre a coluna */
            border: 2px dashed #007bff;
        }
        .column-header {
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #0056b3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .column-header span {
            font-size: 0.9em;
            color: #666;
        }
        .lead-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: grab; /* Indica que o card é arrastável */
            transition: transform 0.2s ease-in-out;
        }
        .lead-card:active {
            cursor: grabbing;
        }
        .lead-card.dragging {
            opacity: 0.5;
            border: 2px dashed #007bff;
        }
        .lead-card h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .lead-card p {
            margin: 0 0 3px 0;
            font-size: 0.9em;
            color: #555;
        }
        .lead-card .value {
            font-weight: bold;
            color: #28a745; /* Cor verde para o valor */
            font-size: 1em;
            margin-top: 5px;
        }
        .loading-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Umbrella Leads Manager - Pipeline de Vendas</h1>

    <div id="pipeline-container">
        <div class="loading-message">Carregando dados do pipeline...</div>
    </div>

    <script>
        const pipelineContainer = document.getElementById('pipeline-container');
        let draggedLeadId = null; // Variável para armazenar o ID do lead sendo arrastado

        // Definir as etapas do pipeline (deve ser a mesma lista do backend)
        const etapas = [
            'Primeiro contato',
            'Apresentação comercial',
            'Viabilidade',
            'Proposta',
            'Negociação',
            'Cliente',
            'Follow-up',
            'Negócio perdido'
        ];

        async function fetchLeads() {
            try {
                const response = await fetch('/api/leads');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const leads = await response.json();
                return leads;
            } catch (error) {
                console.error("Erro ao buscar leads:", error);
                pipelineContainer.innerHTML = '<div class="loading-message" style="color: red;">Erro ao carregar leads. Verifique o console para detalhes.</div>';
                return [];
            }
        }

        async function fetchPipelineStats() {
            try {
                const response = await fetch('/api/pipeline');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const stats = await response.json();
                return stats;
            } catch (error) {
                console.error("Erro ao buscar estatísticas do pipeline:", error);
                return { pipeline: {} };
            }
        }

        function formatCurrency(value) {
            if (value === null || value === undefined) {
                return 'R$ 0,00';
            }
            // Garante que o valor é um número e formata para moeda brasileira
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Função para atualizar a etapa do lead no backend
        async function updateLeadStage(leadId, newStage) {
            try {
                const response = await fetch(`/api/leads/${leadId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ etapa: newStage })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const updatedLead = await response.json();
                console.log(`Lead ${updatedLead.nome} atualizado para a etapa: ${updatedLead.etapa}`);
                return true;
            } catch (error) {
                console.error("Erro ao atualizar etapa do lead:", error);
                alert("Erro ao mover o lead. Por favor, tente novamente.");
                return false;
            }
        }

        async function renderPipeline() {
            pipelineContainer.innerHTML = ''; // Limpa a mensagem de carregamento

            const [leads, pipelineStats] = await Promise.all([
                fetchLeads(),
                fetchPipelineStats()
            ]);

            etapas.forEach(etapa => {
                const column = document.createElement('div');
                column.classList.add('pipeline-column');
                column.dataset.etapa = etapa; // Adiciona um data attribute para identificar a etapa

                // Adiciona eventos de drag and drop para as colunas
                column.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Permite o drop
                    column.classList.add('drag-over');
                });
                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });
                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    if (draggedLeadId) {
                        const newStage = column.dataset.etapa;
                        const success = await updateLeadStage(draggedLeadId, newStage);
                        if (success) {
                            renderPipeline(); // Re-renderiza o pipeline após o sucesso
                        }
                        draggedLeadId = null; // Limpa o ID do lead arrastado
                    }
                });

                const columnHeader = document.createElement('div');
                columnHeader.classList.add('column-header');
                
                const etapaName = document.createElement('span');
                etapaName.textContent = etapa;
                columnHeader.appendChild(etapaName);

                const stats = pipelineStats.pipeline[etapa] || { count: 0, total_valor: 0 };
                const totalValueSpan = document.createElement('span');
                totalValueSpan.textContent = `${stats.count} leads (${formatCurrency(stats.total_valor)})`;
                columnHeader.appendChild(totalValueSpan);

                column.appendChild(columnHeader);

                const leadsInThisStage = leads.filter(lead => lead.etapa === etapa);

                leadsInThisStage.forEach(lead => {
                    const card = document.createElement('div');
                    card.classList.add('lead-card');
                    card.dataset.leadId = lead.id; // Adiciona um data attribute para identificar o lead
                    card.draggable = true; // Torna o card arrastável

                    // Adiciona eventos de drag and drop para os cards
                    card.addEventListener('dragstart', (e) => {
                        draggedLeadId = lead.id;
                        e.dataTransfer.setData('text/plain', lead.id); // Necessário para Firefox
                        card.classList.add('dragging');
                    });
                    card.addEventListener('dragend', () => {
                        card.classList.remove('dragging');
                    });

                    card.innerHTML = `
                        <h4>${lead.nome}</h4>
                        <p>${lead.email}</p>
                        ${lead.empresa ? `<p>Empresa: ${lead.empresa}</p>` : ''}
                        ${lead.valor_negocio !== null ? `<p class="value">Valor: ${formatCurrency(lead.valor_negocio)}</p>` : ''}
                        <!-- Botão de follow-up será adicionado em uma etapa futura -->
                    `;
                    column.appendChild(card);
                });

                pipelineContainer.appendChild(column);
            });
        }

        // Renderiza o pipeline quando a página carregar
        document.addEventListener('DOMContentLoaded', renderPipeline);
    </script>
</body>
</html>
